<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel Tu Peque Recorre 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #100022;
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 20px;
  }

  h1 {
    color: #F9A825;
    margin-bottom: 10px;
  }

  p {
    color: #ccc;
    margin-top: 0;
    margin-bottom: 25px;
    font-size: 0.9em;
  }

  .stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 30px;
  }

  .stat-card {
    background: #1c0133;
    border-radius: 12px;
    padding: 15px 25px;
    box-shadow: 0 0 12px rgba(249, 168, 37, 0.25);
    min-width: 150px;
  }

  .stat-card h3 {
    color: #F9A825;
    margin: 0;
    font-size: 1.1em;
    line-height: 1.3em;
    white-space: normal;
    word-wrap: break-word;
  }

  .stat-card p {
    margin: 5px 0 0;
    font-size: 1.4em;
    font-weight: bold;
  }

  .charts {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 40px;
    max-width: 900px;
    margin: auto;
  }

  .chart-card {
    background: #1c0133;
    border-radius: 12px;
    padding: 20px;
    width: 380px;
    box-shadow: 0 0 15px rgba(249, 168, 37, 0.3);
  }

  canvas {
    width: 100%;
    height: 260px;
  }

  #lastUpdate {
    margin-top: 25px;
    font-size: 0.85em;
    color: #aaa;
  }

  #statusMessage {
    margin-top: 10px;
    font-size: 0.9em;
    color: #ccc;
  }

  @media (max-width: 768px) {
    .charts {
      flex-direction: column;
      align-items: center;
    }
    .chart-card {
      width: 90%;
    }
  }
</style>
</head>
<body>
<h1>üèÉ‚Äç‚ôÄÔ∏è Tu Peque Recorre 2025</h1>
<p>Panel en vivo ‚Äî actualizaci√≥n autom√°tica cada 3 minutos</p>

<div id="statusMessage">Cargando datos...</div>

<!-- üìä Estad√≠sticas principales -->
<div class="stats">
  <div class="stat-card">
    <h3>üë¶ Ni√±os</h3>
    <p id="countNinos">--</p>
  </div>
  <div class="stat-card">
    <h3>üëß Ni√±as</h3>
    <p id="countNinas">--</p>
  </div>
  <div class="stat-card">
    <h3>‚ôø Participantes inclusivos</h3>
    <p id="countCapDif">--</p>
  </div>
  <div class="stat-card">
    <h3>üèÖ Reconocimientos enviados</h3>
    <p id="countReconocimientos">--</p>
  </div>
</div>

<div class="charts">
  <div class="chart-card">
    <h3>Evoluci√≥n de Inscritos</h3>
    <canvas id="totalChart"></canvas>
  </div>
  <div class="chart-card">
    <h3>Inscritos por Categor√≠a</h3>
    <canvas id="categoriaChart"></canvas>
  </div>
  <div class="chart-card">
    <h3>Distribuci√≥n por G√©nero</h3>
    <canvas id="generoChart"></canvas>
  </div>
  <div class="chart-card">
    <h3>üèÖ Progreso de Reconocimientos</h3>
    <canvas id="reconoChart"></canvas>
  </div>
</div>

<p id="lastUpdate">√öltima actualizaci√≥n: --</p>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZO2qvxTwuib5-PUJT28eWfGqftGIn-5pt4e1yh9C0LKEgJAV8u7gmmHpcOjJZKQzd1D8yrrqlFZVb/pub?gid=1619875874&single=true&output=csv";
const proxiedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;

let totalChart, categoriaChart, generoChart, reconoChart;

// Lista de nombres femeninos comunes
const nombresFemeninos = [
  "ana","maria","sofia","valentina","camila","isabella","paula","diana",
  "samantha","lucia","andrea","carla","elena","renata","julieta","mariana",
  "martina","salome","emilia","alexa","natalia","jazmin","eva","bianca","zaira"
];

async function fetchSheetData(){
  const statusMessage = document.getElementById("statusMessage");
  statusMessage.textContent = "Actualizando datos...";
  try {
    const res = await fetch(proxiedUrl);
    if (!res.ok) throw new Error("Error al obtener datos del CSV");
    const text = await res.text();

    const rows = text.split("\n").map(r =>
      r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/(^"|"$)/g,''))
    );
    const headers = rows[0];
    const data = rows.slice(1).filter(r => r.length > 1);

    // Buscar columnas clave
    const iCat    = headers.findIndex(h => h.toLowerCase().includes('categor'));
    const iFecha  = headers.findIndex(h => h.toLowerCase().includes('fecha'));
    const iNombre = headers.findIndex(h => h.toLowerCase().includes('nombre del menor'));
    const iCapDif = headers.findIndex(h => h.toLowerCase().includes('capacidad diferente'));
    const iRecono = headers.findIndex(h => h.toLowerCase().includes('reconocimiento'));

    if (iCat === -1 || iFecha === -1 || iNombre === -1) {
      statusMessage.textContent = "Error: No se encontraron columnas requeridas.";
      return;
    }

    const total = data.length;
    const categorias = ['4 a 6', '7 a 9', '10 a 12', '13 a 15'];
    const inscritosPorCategoria = categorias.map(cat =>
      data.filter(r => r[iCat]?.includes(cat)).length
    );

    // üë¶üëß Determinar g√©nero por nombre
    const ninos = data.filter(r => {
      const nombre = r[iNombre]?.toLowerCase().trim() || "";
      if (!nombre) return false;
      return !nombresFemeninos.some(f => nombre.includes(f)) && !nombre.endsWith("a");
    }).length;

    const ninas = data.filter(r => {
      const nombre = r[iNombre]?.toLowerCase().trim() || "";
      if (!nombre) return false;
      return nombresFemeninos.some(f => nombre.includes(f)) || nombre.endsWith("a");
    }).length;

    // ‚ôø Inclusivos
    const capDif = iCapDif === -1 ? 0 : data.filter(r =>
      r[iCapDif]?.toLowerCase().includes('s√≠') || r[iCapDif]?.toLowerCase().includes('si')
    ).length;

    // üèÖ Reconocimientos enviados
    const reconocimientos = iRecono === -1 ? 0 : data.filter(r =>
      r[iRecono] && r[iRecono].trim() !== ""
    ).length;

    // üìà Evoluci√≥n por fecha
    const fechas = {};
    data.forEach(r => {
      const f = r[iFecha] ? new Date(r[iFecha]).toLocaleDateString('es-MX') : null;
      if (f) fechas[f] = (fechas[f] || 0) + 1;
    });

    const fechasOrdenadas = Object.keys(fechas).sort((a,b) => new Date(a)-new Date(b));
    let acumulado = 0;
    const inscritosPorDia = fechasOrdenadas.map(f => acumulado += fechas[f]);

    updateDashboard({
      total, categorias, inscritosPorCategoria, fechasOrdenadas, inscritosPorDia,
      ninos, ninas, capDif, reconocimientos
    });
    statusMessage.textContent = "Datos actualizados correctamente";
  } catch (err) {
    console.error("‚ùå Error al leer hoja:", err);
    document.getElementById("statusMessage").textContent = "Error al cargar datos.";
  }
}

function updateDashboard(data){
  document.getElementById('lastUpdate').textContent =
    '√öltima actualizaci√≥n: ' + new Date().toLocaleTimeString('es-MX');

  document.getElementById("countNinos").textContent = data.ninos;
  document.getElementById("countNinas").textContent = data.ninas;
  document.getElementById("countCapDif").textContent = data.capDif;
  document.getElementById("countReconocimientos").textContent = data.reconocimientos;

  if (totalChart) totalChart.destroy();
  if (categoriaChart) categoriaChart.destroy();
  if (generoChart) generoChart.destroy();
  if (reconoChart) reconoChart.destroy();

  totalChart = new Chart(document.getElementById('totalChart'), {
    type: 'line',
    data: {
      labels: data.fechasOrdenadas,
      datasets: [{
        label: 'Inscritos acumulados',
        data: data.inscritosPorDia,
        borderColor: '#F9A825',
        backgroundColor: 'rgba(249,168,37,0.25)',
        fill: true,
        tension: 0.4,
        pointRadius: 4,
        pointBackgroundColor: '#fff'
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: `${data.total} participantes totales`,
          color: '#fff',
          font: { size: 16 }
        }
      },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' }, beginAtZero: true }
      },
      animation: { duration: 1000, easing: 'easeOutQuart' }
    }
  });

  categoriaChart = new Chart(document.getElementById('categoriaChart'), {
    type: 'bar',
    data: {
      labels: data.categorias,
      datasets: [{
        label: 'Inscritos',
        data: data.inscritosPorCategoria,
        backgroundColor: ['#00e676','#ffeb3b','#ff9800','#f44336']
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' }, beginAtZero: true }
      },
      animation: { duration: 800, easing: 'easeOutQuad' }
    }
  });

  generoChart = new Chart(document.getElementById('generoChart'), {
    type: 'pie',
    data: {
      labels: ['Ni√±os', 'Ni√±as'],
      datasets: [{
        data: [data.ninos, data.ninas],
        backgroundColor: ['#4FC3F7', '#E91E63']
      }]
    },
    options: {
      plugins: {
        legend: { labels: { color: '#fff' } },
        title: {
          display: true,
          text: 'Distribuci√≥n por G√©nero',
          color: '#fff'
        }
      },
      animation: { duration: 900, easing: 'easeOutBack' }
    }
  });

  // üèÖ Progreso de Reconocimientos
  const progresoRecono = (data.reconocimientos / data.total) * 100;
  reconoChart = new Chart(document.getElementById('reconoChart'), {
    type: 'doughnut',
    data: {
      labels: ['Enviados', 'Pendientes'],
      datasets: [{
        data: [data.reconocimientos, data.total - data.reconocimientos],
        backgroundColor: ['#FFD54F', '#333'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: `${progresoRecono.toFixed(1)}% enviados`,
          color: '#fff'
        }
      }
    }
  });
}

fetchSheetData();
setInterval(fetchSheetData, 180000);
</script>
</body>
</html>
