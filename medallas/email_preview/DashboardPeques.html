<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel Tu Peque Recorre 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #100022;
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 20px;
  }

  h1 {
    color: #F9A825;
    margin-bottom: 10px;
  }

  p {
    color: #ccc;
    margin-top: 0;
    margin-bottom: 25px;
    font-size: 0.9em;
  }

  .stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 30px;
  }

  .stat-card {
    background: #1c0133;
    border-radius: 12px;
    padding: 15px 25px;
    box-shadow: 0 0 12px rgba(249, 168, 37, 0.25);
    min-width: 150px;
  }

  .stat-card h3 {
    color: #F9A825;
    margin: 0;
    font-size: 1.2em;
  }

  .stat-card p {
    margin: 5px 0 0;
    font-size: 1.4em;
    font-weight: bold;
  }

  .charts {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 40px;
    max-width: 900px;
    margin: auto;
  }

  .chart-card {
    background: #1c0133;
    border-radius: 12px;
    padding: 20px;
    width: 380px;
    box-shadow: 0 0 15px rgba(249, 168, 37, 0.3);
  }

  canvas {
    width: 100%;
    height: 260px;
  }

  #lastUpdate {
    margin-top: 25px;
    font-size: 0.85em;
    color: #aaa;
  }

  #statusMessage {
    margin-top: 10px;
    font-size: 0.9em;
    color: #ccc;
  }

  @media (max-width: 768px) {
    .charts {
      flex-direction: column;
      align-items: center;
    }
    .chart-card {
      width: 90%;
    }
  }
</style>
</head>
<body>
<h1>üèÉ‚Äç‚ôÄÔ∏è Tu Peque Recorre 2025</h1>
<p>Panel en vivo ‚Äî actualizaci√≥n autom√°tica cada 3 minutos</p>

<div id="statusMessage">Cargando datos...</div>

<!-- üìä NUEVAS ESTAD√çSTICAS -->
<div class="stats">
  <div class="stat-card">
    <h3>üë¶ Ni√±os</h3>
    <p id="countNinos">--</p>
  </div>
  <div class="stat-card">
    <h3>üëß Ni√±as</h3>
    <p id="countNinas">--</p>
  </div>
  <div class="stat-card">
    <h3>‚ôø Cap. Diferentes</h3>
    <p id="countCapDif">--</p>
  </div>
</div>

<div class="charts">
  <div class="chart-card">
    <h3>Evoluci√≥n de Inscritos</h3>
    <canvas id="totalChart"></canvas>
  </div>
  <div class="chart-card">
    <h3>Inscritos por Categor√≠a</h3>
    <canvas id="categoriaChart"></canvas>
  </div>
</div>

<p id="lastUpdate">√öltima actualizaci√≥n: --</p>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZO2qvxTwuib5-PUJT28eWfGqftGIn-5pt4e1yh9C0LKEgJAV8u7gmmHpcOjJZKQzd1D8yrrqlFZVb/pub?gid=1619875874&single=true&output=csv";
const proxiedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;

let totalChart, categoriaChart;

async function fetchSheetData(){
  const statusMessage = document.getElementById("statusMessage");
  statusMessage.textContent = "Actualizando datos...";
  try {
    const res = await fetch(proxiedUrl);
    if (!res.ok) throw new Error("Error al obtener datos del CSV");
    const text = await res.text();

    const rows = text.split("\n").map(r =>
      r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/(^"|"$)/g,''))
    );
    const headers = rows[0];
    const data = rows.slice(1).filter(r => r.length > 1);

    // √çndices relevantes
    const iCat = headers.findIndex(h => h.toLowerCase().includes('categor'));
    const iFecha = headers.findIndex(h => h.toLowerCase().includes('fecha'));
    const iSexo = headers.findIndex(h => h.toLowerCase().includes('sexo'));
    const iCapDif = headers.findIndex(h => h.toLowerCase().includes('cap'));

    if (iCat === -1 || iFecha === -1) {
      statusMessage.textContent = "Error: No se encontraron columnas requeridas.";
      console.error("‚ùå Faltan columnas requeridas");
      return;
    }

    // üìä Totales
    const total = data.length;
    const categorias = ['4 a 6', '7 a 9', '10 a 12', '13 a 15'];
    const inscritosPorCategoria = categorias.map(cat =>
      data.filter(r => r[iCat]?.includes(cat)).length
    );

    // üë¶üëß Conteos por g√©nero y capacidades
    const ninos = data.filter(r => r[iSexo]?.toLowerCase().includes('ni√±') && !r[iSexo].toLowerCase().includes('a')).length;
    const ninas = data.filter(r => r[iSexo]?.toLowerCase().includes('ni√±a')).length;
    const capDif = data.filter(r => r[iCapDif]?.toLowerCase().includes('s√≠') || r[iCapDif]?.toLowerCase().includes('si')).length;

    // üìà Agrupar por fecha (para gr√°fico de evoluci√≥n)
    const fechas = {};
    data.forEach(r => {
      const f = r[iFecha] ? new Date(r[iFecha]).toLocaleDateString('es-MX') : null;
      if (f) fechas[f] = (fechas[f] || 0) + 1;
    });

    const fechasOrdenadas = Object.keys(fechas).sort((a, b) => new Date(a) - new Date(b));
    let acumulado = 0;
    const inscritosPorDia = fechasOrdenadas.map(f => acumulado += fechas[f]);

    updateDashboard({ total, categorias, inscritosPorCategoria, fechasOrdenadas, inscritosPorDia, ninos, ninas, capDif });
    statusMessage.textContent = "Datos actualizados correctamente";
  } catch (err) {
    console.error("‚ùå Error al leer hoja:", err);
    document.getElementById("statusMessage").textContent = "Error al cargar datos.";
  }
}

function updateDashboard(data){
  document.getElementById('lastUpdate').textContent =
    '√öltima actualizaci√≥n: ' + new Date().toLocaleTimeString('es-MX');

  // Actualizar contadores
  document.getElementById("countNinos").textContent = data.ninos;
  document.getElementById("countNinas").textContent = data.ninas;
  document.getElementById("countCapDif").textContent = data.capDif;

  // Destruir gr√°ficos previos
  if (totalChart) totalChart.destroy();
  if (categoriaChart) categoriaChart.destroy();

  // üìà Gr√°fico de l√≠neas (evoluci√≥n de inscritos)
  totalChart = new Chart(document.getElementById('totalChart'), {
    type: 'line',
    data: {
      labels: data.fechasOrdenadas,
      datasets: [{
        label: 'Inscritos acumulados',
        data: data.inscritosPorDia,
        borderColor: '#F9A825',
        backgroundColor: 'rgba(249,168,37,0.25)',
        fill: true,
        tension: 0.4,
        pointRadius: 4,
        pointBackgroundColor: '#fff'
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: `${data.total} participantes totales`,
          color: '#fff',
          font: { size: 16 }
        }
      },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' }, beginAtZero: true }
      },
      animation: { duration: 1000, easing: 'easeOutQuart' }
    }
  });

  // üìä Gr√°fico de barras (por categor√≠a)
  categoriaChart = new Chart(document.getElementById('categoriaChart'), {
    type: 'bar',
    data: {
      labels: data.categorias,
      datasets: [{
        label: 'Inscritos',
        data: data.inscritosPorCategoria,
        backgroundColor: ['#00e676','#ffeb3b','#ff9800','#f44336']
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' }, beginAtZero: true }
      },
      animation: { duration: 800, easing: 'easeOutQuad' }
    }
  });
}

fetchSheetData();
setInterval(fetchSheetData, 180000);
</script>
</body>
</html>
