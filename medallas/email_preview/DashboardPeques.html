<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel Tu Peque Recorre 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #120022;
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 20px;
  }

  h1 {
    color: #F9A825;
    margin-bottom: 10px;
  }

  p {
    color: #ccc;
    margin-top: 0;
    margin-bottom: 25px;
    font-size: 0.9em;
  }

  .charts {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 40px;
    max-width: 900px;
    margin: auto;
  }

  .chart-card {
    background: #1d0133;
    border-radius: 12px;
    padding: 20px;
    width: 380px;
    box-shadow: 0 0 15px rgba(249, 168, 37, 0.3);
  }

  canvas {
    width: 100%;
    height: 260px;
  }

  #lastUpdate {
    margin-top: 25px;
    font-size: 0.85em;
    color: #aaa;
  }

  @media (max-width: 768px) {
    .charts {
      flex-direction: column;
      align-items: center;
    }
    .chart-card {
      width: 90%;
    }
  }
</style>
</head>
<body>
<h1>üèÉ‚Äç‚ôÄÔ∏è Tu Peque Recorre 2025</h1>
<p>Panel en vivo ‚Äî actualizaci√≥n autom√°tica cada 3 minutos</p>

<div class="charts">
  <div class="chart-card">
    <h3>Total de Inscritos</h3>
    <canvas id="totalChart"></canvas>
  </div>
  <div class="chart-card">
    <h3>Inscritos por Categor√≠a</h3>
    <canvas id="categoriaChart"></canvas>
  </div>
</div>

<p id="lastUpdate">√öltima actualizaci√≥n: --</p>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZO2qvxTwuib5-PUJT28eWfGqftGIn-5pt4e1yh9C0LKEgJAV8u7gmmHpcOjJZKQzd1D8yrrqlFZVb/pub?gid=1619875874&single=true&output=csv";
const proxiedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;

let totalChart, categoriaChart;

async function fetchSheetData(){
  try {
    const res = await fetch(proxiedUrl);
    const text = await res.text();

    const rows = text.split("\n").map(r =>
      r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/(^"|"$)/g,''))
    );
    const headers = rows[0];
    const data = rows.slice(1).filter(r => r.length > 1);

    const iCat = headers.findIndex(h => h.includes('Categor√≠a'));
    const total = data.length;
    const categorias = ['4 a 6', '7 a 9', '10 a 12', '13 a 15'];
    const inscritosPorCategoria = categorias.map(cat => data.filter(r => r[iCat]?.includes(cat)).length);

    updateDashboard({ total, categorias, inscritosPorCategoria });
  } catch (err) {
    console.error("‚ùå Error al leer hoja:", err);
  }
}

function updateDashboard(data){
  document.getElementById('lastUpdate').textContent =
    '√öltima actualizaci√≥n: ' + new Date().toLocaleTimeString('es-MX');

  if (totalChart) totalChart.destroy();
  if (categoriaChart) categoriaChart.destroy();

  totalChart = new Chart(document.getElementById('totalChart'), {
    type: 'doughnut',
    data: {
      labels: ['Inscritos'],
      datasets: [{
        data: [data.total],
        backgroundColor: ['#F9A825'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '75%',
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: `${data.total} participantes`,
          color: '#fff',
          font: { size: 18 }
        }
      }
    }
  });

  categoriaChart = new Chart(document.getElementById('categoriaChart'), {
    type: 'bar',
    data: {
      labels: data.categorias,
      datasets: [{
        label: 'Inscritos',
        data: data.inscritosPorCategoria,
        backgroundColor: ['#00e676','#ffeb3b','#ff9800','#f44336']
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' }, beginAtZero: true }
      }
    }
  });
}

fetchSheetData();
setInterval(fetchSheetData, 180000);
</script>
</body>
</html>
