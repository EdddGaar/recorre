<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel Re-corre Running Club</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    --gold: #F9A825;
    --bg1: #0f0120;
    --bg2: #1b0033;
    --card-bg: rgba(17, 0, 34, 0.7);
  }
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 20px;
    text-align: center;
    color: #fff;
    background: linear-gradient(120deg, var(--bg1), var(--bg2));
    background-size: 200% 200%;
    animation: gradientShift 10s ease infinite;
    overflow: hidden;
    height: 100vh;
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  h1 {
    font-size: 1.8em;
    margin: 0;
    color: var(--gold);
    text-shadow: 0 0 10px var(--gold);
    animation: glow 2s ease-in-out infinite alternate;
  }
  @keyframes glow { from { opacity: .9 } to { opacity: 1 } }

  .subtitle {
    font-size: 0.9em;
    color: #ccc;
    margin-bottom: 20px;
  }

  .dashboard {
    display: grid;
    grid-template-rows: auto 1fr;
    gap: 16px;
    height: calc(100vh - 100px);
  }

  .kpi-container {
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .kpi {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 12px 16px;
    min-width: 130px;
    box-shadow: 0 0 12px rgba(249,168,37,0.25);
    backdrop-filter: blur(6px);
    transition: transform 0.3s ease;
  }
  .kpi:hover { transform: scale(1.03); }

  .kpi h2 {
    font-size: 1.8em;
    margin: 0;
    color: var(--gold);
  }
  .kpi p {
    margin: 4px 0 0;
    font-size: 0.8em;
    color: #bbb;
  }

  .charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: stretch;
    height: 100%;
  }

  canvas {
    background: rgba(26, 0, 51, 0.6);
    border-radius: 16px;
    box-shadow: 0 0 12px rgba(249,168,37,0.2);
    padding: 6px;
  }

  #lastUpdate {
    margin-top: 10px;
    font-size: 0.8em;
    color: #aaa;
  }

  @media (max-width: 768px) {
    .charts { grid-template-columns: 1fr; height: auto; }
    body { overflow-y: auto; height: auto; }
  }
</style>
</head>
<body>
<h1>üèÉ‚Äç‚ôÄÔ∏è Tu Peque Recorre 2025</h1>
<p class="subtitle">Panel en vivo ‚Äî actualizaci√≥n autom√°tica cada 3 min</p>

<div class="dashboard">
  <div class="kpi-container" id="kpiContainer">
    <div class="kpi"><h2 id="inscritos">0</h2><p>Inscritos</p></div>
    <div class="kpi"><h2 id="correos">0</h2><p>Correos</p></div>
    <div class="kpi"><h2 id="asistencia">0</h2><p>Asistencias</p></div>
    <div class="kpi"><h2 id="reconocimientos">0</h2><p>Reconocimientos</p></div>
  </div>

  <div class="charts">
    <canvas id="categoriaChart"></canvas>
    <canvas id="correosDiaChart"></canvas>
  </div>
</div>

<p id="lastUpdate">√öltima actualizaci√≥n: --</p>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZO2qvxTwuib5-PUJT28eWfGqftGIn-5pt4e1yh9C0LKEgJAV8u7gmmHpcOjJZKQzd1D8yrrqlFZVb/pub?gid=1619875874&single=true&output=csv";
const proxiedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;

let categoriaChart, correosDiaChart;

async function fetchSheetData(){
 try {
   const res = await fetch(proxiedUrl);
   const text = await res.text();
   const rows = text.split("\n").map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/(^"|"$)/g,'')));
   const headers = rows[0];
   const data = rows.slice(1).filter(r => r.length > 1);

   const iCat = headers.findIndex(h => h.includes('Categor√≠a'));
   const iCorreo = headers.findIndex(h => h.includes('Correo'));
   const iAsis = headers.findIndex(h => h.includes('Asistencia'));
   const iRec = headers.findIndex(h => h.includes('Reconocimiento'));
   const iFecha = headers.findIndex(h => h.includes('Fecha'));

   const total = data.length;
   const correos = data.filter(r => r[iCorreo] === '‚úÖ').length;
   const asis = data.filter(r => r[iAsis] === '‚úÖ').length;
   const recs = data.filter(r => r[iRec] === '‚úÖ').length;

   const categorias = ['4 a 6', '7 a 9', '10 a 12', '13 a 15'];
   const inscritosPorCategoria = categorias.map(cat => data.filter(r => r[iCat]?.includes(cat)).length);

   const fechas = {};
   data.forEach(r => {
     const f = r[iFecha];
     if (f && r[iCorreo] === '‚úÖ') {
       const d = new Date(f).toLocaleDateString('es-MX');
       fechas[d] = (fechas[d] || 0) + 1;
     }
   });
   const dias = Object.keys(fechas);
   const correosPorDia = Object.values(fechas);

   updateDashboard({ total, correos, asis, recs, categorias, inscritosPorCategoria, dias, correosPorDia });
 } catch (err) {
   console.error("‚ùå Error al leer hoja:", err);
 }
}

function animateNumber(id, value){
 const el = document.getElementById(id);
 const current = parseInt(el.textContent) || 0;
 const diff = value - current;
 let step = 0; const steps = 25;
 const interval = setInterval(() => {
   step++;
   el.textContent = Math.round(current + diff * (step / steps));
   if (step >= steps) clearInterval(interval);
 }, 40);
}

function updateDashboard(data){
 animateNumber('inscritos', data.total);
 animateNumber('correos', data.correos);
 animateNumber('asistencia', data.asis);
 animateNumber('reconocimientos', data.recs);
 document.getElementById('lastUpdate').textContent =
   '√öltima actualizaci√≥n: ' + new Date().toLocaleTimeString('es-MX');

 if (categoriaChart) categoriaChart.destroy();
 if (correosDiaChart) correosDiaChart.destroy();

 categoriaChart = new Chart(document.getElementById('categoriaChart'), {
   type: 'bar',
   data: {
     labels: data.categorias,
     datasets: [{
       label: 'Inscritos por categor√≠a',
       data: data.inscritosPorCategoria,
       backgroundColor: ['#00e676','#ffeb3b','#ff9800','#f44336']
     }]
   },
   options: {
     plugins: { legend: { display: false } },
     scales: { 
       x: { ticks: { color: '#fff' } },
       y: { ticks: { color: '#fff' } }
     }
   }
 });

 correosDiaChart = new Chart(document.getElementById('correosDiaChart'), {
   type: 'line',
   data: {
     labels: data.dias,
     datasets: [{
       label: 'Correos por d√≠a',
       data: data.correosPorDia,
       borderColor: '#F9A825',
       backgroundColor: 'rgba(249,168,37,0.3)',
       fill: true,
       tension: 0.3
     }]
   },
   options: {
     plugins: { legend: { display: false } },
     scales: { 
       x: { ticks: { color: '#fff' } },
       y: { ticks: { color: '#fff' } }
     }
   }
 });
}

fetchSheetData();
setInterval(fetchSheetData, 180000);
</script>
</body>
</html>
