<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tu Peque Recorre ‚Äì Check-in</title>
<style>
  /* üé® Estilos base */
  body {
    font-family: Poppins, system-ui, Arial, sans-serif;
    margin: 0;
    background: radial-gradient(circle at top, #2e004f, #000);
    color: #fff;
    text-align: center;
    min-height: 100vh;
  }
  h1 { color: #ffca28; margin: 18px 0; }
  p { line-height: 1.5em; }
  input {
    padding: 10px;
    border-radius: 8px;
    border: none;
    width: 80%;
    max-width: 320px;
    text-align: center;
    font-size: 16px;
  }
  .btn {
    display: inline-block;
    margin-top: 8px;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: #7b1fa2;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease-in-out;
  }
  .btn:hover { background: #9c27b0; transform: scale(1.05); }
  .btn-danger { background: #c62828; }
  .btn-danger:hover { background: #e53935; }
  .btn-home {
    display: inline-block;
    background: #2196f3;
    margin-top: 18px;
  }
  .btn-home:hover { background: #42a5f5; transform: scale(1.05); }

  /* üì∏ C√°mara y video */
  #video {
    width: 90%;
    max-width: 420px;
    border: 4px solid transparent;
    border-radius: 10px;
    margin-top: 16px;
    display: block;
    box-shadow: 0 0 8px rgba(0, 0, 0, .3);
    opacity: 0;
    transition: opacity .4s;
  }
  .scanning {
    animation: glow 1.5s infinite alternate;
    border-color: #00e676 !important;
  }
  @keyframes glow {
    from { box-shadow: 0 0 5px #00e676; }
    to { box-shadow: 0 0 25px #00e676; }
  }

  select {
    padding: 6px;
    border-radius: 8px;
    font-size: 15px;
    margin-top: 8px;
  }

  footer {
    font-size: 13px;
    color: #ccc;
    margin: 28px 0 18px;
  }
  footer a {
    color: #ffca28;
    text-decoration: none;
    font-weight: 600;
  }
  .debug {
    font-size: 12px;
    color: #ddd;
    margin-top: 8px;
    opacity: 0.9;
  }

  /* üîÑ Animaci√≥n de ‚ÄúBuscando participante‚Ä¶‚Äù */
  #loading {
    display: none;
    margin-top: 18px;
  }
  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top: 4px solid #ffca28;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>
</head>

<body>

  <!-- üñºÔ∏è Encabezado -->
  <img src="https://raw.githubusercontent.com/EdddGaar/recorre/main/medallas/Google%20Encabezado.png" 
       alt="logo" 
       style="width:280px;border-radius:12px;margin-top:12px">
  <h1>üèÉ Tu Peque Recorre 2025</h1>
  <p>Escanea el c√≥digo QR o busca por nombre, n√∫mero o ID (ej. PEQUE-001).</p>

  <!-- üîç Buscador -->
  <input id="search" placeholder="Escribe nombre, n√∫mero o ID...">
  <br>
  <button class="btn" onclick="buscar()">üîç Buscar</button>
  <a class="btn" href="https://docs.google.com/forms/d/e/1FAIpQLSdDTz9PVHjsAJ4Npmbt97j-UytmgrdcWOoylQIAIq1yF5ek4w/viewform?usp=sharing" target="_blank" rel="noopener">‚ûï Registrar otro</a>

  <!-- üí´ Indicador de carga -->
  <div id="loading">
    <div class="spinner"></div>
    <p>üîé Buscando participante...</p>
  </div>

  <!-- üì∑ Secci√≥n de c√°mara -->
  <h3 style="margin-top:22px;">üì∑ Escanear c√≥digo QR</h3>
  <select id="cameraSelect"></select><br>
  <button id="startButton" class="btn">Iniciar c√°mara</button>
  <button id="stopButton" class="btn btn-danger" style="display:none">Detener c√°mara</button>

  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" hidden></canvas>
  <p id="outputMessage"></p>
  <div class="debug" id="debug"></div>

  <!-- üè† Bot√≥n de inicio -->
  <a href="https://EdddGaar.github.io/recorre/medallas/email_preview/CheckInPage.html" class="btn btn-home">üè† Inicio</a>

  <!-- ‚öì Footer -->
  <footer>
    ¬© Re-corre Running Club ‚Äì Tu Peque Recorre 2025<br>
    <a href="https://maps.app.goo.gl/Lv7UhyM3f6Kuzbf17" target="_blank" rel="noopener">üìç Ver ubicaci√≥n del evento</a>
  </footer>

  <!-- üß† Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    // üëâ URL del WebApp publicado (√∫ltima versi√≥n /exec)
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx8SeyAJil3spgt2P8VK4wqR2ZfUwqj04PXpjkXcBxY-MXReUHIXXphO5shKuG9EQnf/exec";

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cameraSelect = document.getElementById('cameraSelect');
    const output = document.getElementById('outputMessage');
    const debug = document.getElementById('debug');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    let stream, scanning = false;

    // üîç Buscar participante
    function buscar() {
      const v = document.getElementById('search').value.trim();
      const loading = document.getElementById('loading');
      if (v) {
        loading.style.display = 'block';
        // Pausa para mostrar la animaci√≥n antes de redirigir
        setTimeout(() => {
          window.location.replace(WEBAPP_URL + '?q=' + encodeURIComponent(v));
        }, 400);
      }
    }

    // üì∏ Listar c√°maras
    async function listarCamaras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const vids = devices.filter(d => d.kind === 'videoinput');
      cameraSelect.innerHTML = '';
      vids.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId; opt.text = d.label || `C√°mara ${i + 1}`;
        cameraSelect.appendChild(opt);
      });
      const back = vids.find(d => /back|environment/i.test(d.label));
      if (back) cameraSelect.value = back.deviceId;
      return vids.length > 0;
    }

    // ‚ñ∂Ô∏è Iniciar escaneo
    async function startScan() {
      try {
        await listarCamaras();
        const deviceId = cameraSelect.value;
        const constraints = deviceId
          ? { video: { deviceId: { exact: deviceId } } }
          : { video: { facingMode: { ideal: 'environment' } } };
        video.setAttribute('playsinline', '');
        video.setAttribute('autoplay', '');
        video.setAttribute('muted', '');
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play().catch(() => {});
        video.style.opacity = 1;
        scanning = true;
        video.classList.add('scanning');
        startButton.style.display = 'none';
        stopButton.style.display = 'inline-block';
        output.textContent = "üì∑ Escaneando c√≥digo QR...";
        requestAnimationFrame(scanFrame);
      } catch (err) {
        console.error(err);
        output.textContent = "‚ùå No se pudo acceder a la c√°mara. Revisa permisos del navegador.";
      }
    }

    // ‚èπÔ∏è Detener escaneo
    function stopScan() {
      scanning = false;
      video.classList.remove('scanning');
      if (stream) stream.getTracks().forEach(t => t.stop());
      startButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      output.textContent = "C√°mara detenida.";
    }

    cameraSelect.addEventListener('change', () => {
      if (scanning) { stopScan(); startScan(); }
    });

    // üß≠ Escaneo continuo de frames
    function scanFrame() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(img.data, img.width, img.height, { inversionAttempts: "dontInvert" });
        if (code) {
          stopScan();
          output.textContent = "‚úÖ C√≥digo: " + code.data;
          debug.textContent = "Decodificado: " + code.data;
          if (navigator.vibrate) navigator.vibrate(80);
          if (code.data.startsWith("https://script.google.com")) {
            window.location.replace(code.data);
          } else {
            window.location.replace(WEBAPP_URL + "?id=" + encodeURIComponent(code.data.trim()));
          }
          return;
        }
      }
      requestAnimationFrame(scanFrame);
    }

    startButton.onclick = startScan;
    stopButton.onclick = stopScan;
  </script>
</body>
</html>
