<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tu Peque Recorre 2025 ‚Äì Check-in</title>

<!-- üåü ESTILOS PRINCIPALES -->
<style>
  :root {
    --primary: #7b1fa2;
    --accent: #ffca28;
    --bg1: #120024;
    --bg2: #000000;
  }

  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: radial-gradient(circle at top, var(--bg1), var(--bg2));
    color: white;
    text-align: center;
    overflow-x: hidden;
  }

  h1 {
    color: var(--accent);
    text-shadow: 0 0 10px #ffeb3b;
    animation: glow 2s ease-in-out infinite alternate;
  }

  @keyframes glow {
    from { text-shadow: 0 0 5px #ffca28, 0 0 15px #ffca28; }
    to { text-shadow: 0 0 20px #ffeb3b, 0 0 30px #ffeb3b; }
  }

  header { padding-top: 20px; }

  .logo {
    width: 280px;
    border-radius: 12px;
    margin-bottom: 10px;
  }

  input {
    padding: 10px;
    border-radius: 8px;
    border: none;
    width: 80%;
    max-width: 320px;
    text-align: center;
    font-size: 16px;
    margin-top: 8px;
  }

  button {
    margin-top: 10px;
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    background: var(--primary);
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  button:hover {
    background: #9c27b0;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(156,39,176,0.4);
  }

  #video {
    width: 90%;
    max-width: 420px;
    border: 4px solid transparent;
    border-radius: 12px;
    margin-top: 18px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    opacity: 0;
    transition: opacity 0.4s ease-in;
  }

  .scanning {
    animation: scanBorder 1.2s infinite alternate;
    border-color: #00e676 !important;
  }

  @keyframes scanBorder {
    from { box-shadow: 0 0 10px #00e676; }
    to { box-shadow: 0 0 30px #00e676; }
  }

  .checkmark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 120px;
    color: #00e676;
    opacity: 0;
    transition: all 0.6s ease-out;
    z-index: 10;
    text-shadow: 0 0 20px #00ff88;
  }

  .checkmark.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }

  footer {
    font-size: 13px;
    color: #ccc;
    padding: 20px 0;
    z-index: 5;
  }

  footer a {
    color: var(--accent);
    text-decoration: none;
    font-weight: bold;
  }

  /* üåå Animaci√≥n part√≠culas */
  .particles {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
  }

  .particle {
    position: absolute;
    width: 6px; height: 6px;
    background: #b388ff;
    border-radius: 50%;
    opacity: 0.6;
    animation: float 10s infinite ease-in-out;
  }

  @keyframes float {
    0% { transform: translateY(100vh) scale(0.5); opacity: 0.1; }
    50% { opacity: 0.9; }
    100% { transform: translateY(-10vh) scale(1.2); opacity: 0.1; }
  }

  .category-legend {
    margin-top: 25px;
    font-size: 14px;
    color: #fff;
    opacity: 0.9;
  }

</style>
</head>

<body>
  <div class="particles" id="particles"></div>

  <header>
    <img src="https://raw.githubusercontent.com/EdddGaar/recorre/main/medallas/Google%20Encabezado.png" alt="Tu Peque Recorre" class="logo">
    <h1>üèÉ Tu Peque Recorre 2025</h1>
    <p>Escanea el c√≥digo QR o busca por nombre, n√∫mero o ID (ej. PEQUE-001).</p>
  </header>

  <main>
    <input id="search" placeholder="Escribe nombre, n√∫mero o ID...">
    <br>
    <button onclick="buscar()">üîç Buscar</button>

    <h3 style="margin-top:25px;">üì∑ Escanear c√≥digo QR</h3>
    <select id="cameraSelect"></select>
    <br>
    <button id="startButton" onclick="startScan()">Iniciar c√°mara</button>
    <button id="stopButton" onclick="stopScan()" style="display:none;background:#c62828;">Detener c√°mara</button>
    <br>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" hidden></canvas>
    <p id="outputMessage" style="margin-top:10px;">Esperando acci√≥n...</p>

    <div class="category-legend">
      <strong>9. Categor√≠a de participaci√≥n:</strong><br>
      üü¢ 4 a 6 a√±os (Verde) &nbsp;|&nbsp;
      üü° 7 a 9 a√±os (Amarilla) &nbsp;|&nbsp;
      üü† 10 a 12 a√±os (Naranja) &nbsp;|&nbsp;
      üî¥ 13 a 15 a√±os (Roja)
    </div>
  </main>

  <footer>
    ¬© Re-corre Running Club ‚Äì Tu Peque Recorre 2025<br>
    <a href="https://maps.app.goo.gl/Lv7UhyM3f6Kuzbf17" target="_blank" rel="noopener noreferrer">
      üìç Ver ubicaci√≥n del evento
    </a>
  </footer>

  <div class="checkmark" id="checkmark">‚úÖ</div>

  <!-- Librer√≠a QR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <!-- Script principal -->
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cameraSelect = document.getElementById('cameraSelect');
    const output = document.getElementById('outputMessage');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const checkmark = document.getElementById('checkmark');
    const particlesContainer = document.getElementById('particles');
    let stream;
    let scanning = false;

    // Crear part√≠culas flotantes
    for (let i = 0; i < 35; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDelay = (Math.random() * 10) + 's';
      p.style.animationDuration = (8 + Math.random() * 8) + 's';
      particlesContainer.appendChild(p);
    }

    // Buscar manualmente
    function buscar() {
      const val = document.getElementById('search').value.trim();
      if (val) {
        window.location.href =
          'https://script.google.com/macros/s/AKfycbx8SeyAJil3spgt2P8VK4wqR2ZfUwqj04PXpjkXcBxY-MXReUHIXXphO5shKuG9EQnf/exec?q=' +
          encodeURIComponent(val);
      }
    }

    // Listar c√°maras
    async function listarCamaras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === 'videoinput');
      cameraSelect.innerHTML = '';
      videoDevices.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.text = d.label || `C√°mara ${i + 1}`;
        cameraSelect.appendChild(opt);
      });
    }

    // Iniciar escaneo
    async function startScan() {
      try {
        await listarCamaras();
        const constraints = {
          video: {
            deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined,
            facingMode: cameraSelect.value ? undefined : { ideal: 'environment' }
          }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play().catch(()=>{});
          video.style.opacity = 1;
        };
        await video.play();
        scanning = true;
        video.classList.add('scanning');
        startButton.style.display = 'none';
        stopButton.style.display = 'inline-block';
        output.textContent = "üì∑ Escaneando c√≥digo QR...";
        requestAnimationFrame(scanFrame);
      } catch (err) {
        console.error("Error al iniciar c√°mara:", err);
        output.textContent = "‚ùå No se pudo acceder a la c√°mara.";
      }
    }

    // Detener escaneo
    function stopScan() {
      scanning = false;
      video.classList.remove('scanning');
      if (stream) stream.getTracks().forEach(t => t.stop());
      startButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      output.textContent = "C√°mara detenida.";
    }

    // Escanear frame
    function scanFrame() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

        if (code) {
          scanning = false;
          stopScan();
          output.textContent = "‚úÖ C√≥digo detectado: " + code.data;

          // Efecto vibraci√≥n + sonido + check verde
          if (navigator.vibrate) navigator.vibrate(100);
          const beep = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
          beep.play().catch(()=>{});
          checkmark.classList.add('show');
          setTimeout(() => checkmark.classList.remove('show'), 2000);

          // Redirecci√≥n
          setTimeout(() => {
            if (code.data.startsWith("https://")) {
              window.location.href = code.data;
            } else {
              window.location.href = 
                "https://script.google.com/macros/s/AKfycbx8SeyAJil3spgt2P8VK4wqR2ZfUwqj04PXpjkXcBxY-MXReUHIXXphO5shKuG9EQnf/exec?id=" + 
                encodeURIComponent(code.data.trim());
            }
          }, 1000);
          return;
        }
      }
      requestAnimationFrame(scanFrame);
    }
  </script>
</body>
</html>
