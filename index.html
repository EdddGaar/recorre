<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Re-corre | Cumplea√±os</title>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Favicon -->
  <link rel="icon" href="https://github.com/EdddGaar/recorre/raw/main/Re%20corre%20Logo.jpg">

  <style>
    :root{ --text:#ffffff; --p1:#6faeff; --p2:#5977ff; --p3:#7a61ff; --p4:#b4a8ff; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,sans-serif; color:var(--text); background:#1a2040; overflow-x:hidden; }

    /* Fondos */
    .wallpapers{ position:fixed; inset:0; z-index:-5; overflow:hidden; background:#000; }
    .wallpapers img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity 1s ease-in-out; }
    .wallpapers img.show{ opacity:1; }
    .gradient{
      position:fixed; inset:0; z-index:-4;
      background:linear-gradient(135deg, var(--p1) 0%, var(--p2) 45%, var(--p3) 80%);
      background-size:140% 140%; animation:gradientShift 14s ease-in-out infinite alternate; opacity:.78;
    }
    @keyframes gradientShift{ 0%{background-position:0% 50%} 100%{background-position:100% 50%} }

    /* Estrellas */
    #stars{ position:fixed; inset:0; z-index:-2; pointer-events:none; mix-blend-mode:screen; opacity:.9 }

    /* Confeti */
    .confetti{ position:fixed; top:-10px; width:8px; height:14px; z-index:5; opacity:.98; border-radius:2px; pointer-events:none; animation:fall linear forwards; filter:drop-shadow(0 2px 2px rgba(0,0,0,.12)); mix-blend-mode:screen; }
    @keyframes fall{ to{ transform:translateY(110vh) rotate(520deg); opacity:1 } }

    header{text-align:center; padding:28px 18px 8px}
    .logo{width:120px; height:120px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,.85); box-shadow:0 0 40px rgba(0,0,0,.35); margin-bottom:12px}
    .brand{font-family:Outfit; font-weight:900; font-size:clamp(28px,4.4vw,52px); color:#fff; text-shadow:0 3px 12px rgba(0,0,0,.45)}

    main{max-width:980px; margin:0 auto 86px; padding:0 18px}
    .phrase{ text-align:center; margin:10px auto 18px; max-width:880px; font-size:clamp(16px,2.4vw,20px);
      color:#fff; background:rgba(0,0,0,.20); border:1px solid rgba(255,255,255,.25); border-radius:16px; padding:12px 16px; backdrop-filter: blur(6px)
    }

    /* Botones */
    .toolbar{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:6px 0 14px}
    .btn{
      appearance:none; border:none; border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:800; font-family:Inter;
      background:linear-gradient(180deg,#fff,#f2f5ff); color:#1a2040; box-shadow:0 8px 24px rgba(0,0,0,.25), inset 0 1px 0 #fff; transition:.2s;
    }
    .btn:hover{transform:translateY(-1px);}
    .btn.active{background:linear-gradient(180deg, var(--p2), var(--p3)); color:#fff; box-shadow:0 8px 28px rgba(0,0,0,.35);}

    /* Secciones */
    .section{margin:22px auto; padding:16px; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.26); border-radius:22px; backdrop-filter: blur(14px); box-shadow:0 10px 36px rgba(0,0,0,.35)}
    .title-day{ text-align:center; font-family:Outfit; font-weight:900; margin:0 0 14px; font-size:clamp(24px,5vw,40px) }
    .cards{ display:grid; grid-template-columns:1fr; gap:14px; max-width:760px; margin:0 auto }
    @media(min-width:720px){ .cards{ grid-template-columns:repeat(2,1fr) } }
    .card{ position:relative; text-align:center; padding:18px 16px; border-radius:18px; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.90)); color:#1a2040; box-shadow:0 6px 28px rgba(0,0,0,.30) }
    .name{ font-family:Outfit; font-weight:900; font-size:20px; margin:0 0 6px }
    .meta{ font-size:14px; margin:0 0 8px; color:#333 }
    .wish{ font-size:15px; margin:0 }

    /* Card vac√≠a */
    .empty-card{ width:min(520px, 92%); margin:0 auto; display:flex; align-items:center; justify-content:center; text-align:center; padding:32px 20px; border-radius:22px;
      background:linear-gradient(160deg, rgba(255,255,255,.25), rgba(255,255,255,.12)); border:2px dashed rgba(255,255,255,.5); box-shadow:0 8px 28px rgba(0,0,0,.35);
    }
    .empty-card .wish{
      font-size:clamp(18px,2.4vw,24px); font-weight:700; background: linear-gradient(90deg,#ff7aa2,#7a61ff,#00d1ff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin:0;
    }

    footer{text-align:center; padding:24px 16px; font-size:18px; color:#fff }
    #countdown{ margin-top:10px; font-family:Outfit; font-weight:900; font-size:clamp(20px,4vw,36px) }
  </style>
</head>
<body>
  <!-- Fondos -->
  <div class="wallpapers" aria-hidden="true"></div>
  <div class="gradient" aria-hidden="true"></div>
  <canvas id="stars"></canvas>

  <header>
    <img class="logo" src="https://github.com/EdddGaar/recorre/raw/main/Re%20corre%20Logo.jpg" alt="Logo Re-corre" />
    <div class="brand">Re-corre</div>
  </header>

  <main>
    <p class="phrase" id="status">Cargando cumplea√±er@s‚Ä¶</p>
    <div class="toolbar">
      <button class="btn" id="btn-celebrar">Celebrar</button>
      <button class="btn" id="btn-hoy">Ir a HOY</button>
      <button class="btn active" id="btn-week">Semana</button>
      <button class="btn" id="btn-month">Mes</button>
      <button class="btn" id="btn-year">A√±o</button>
      <button class="btn" id="btn-reload">Recargar</button>
    </div>

    <section class="section" id="week-section">
      <h2 class="title-day">üéâ Cumplea√±os de la Semana</h2>
      <div id="week-view"></div>
    </section>

    <section class="section" id="month-section" style="display:none">
      <h2 class="title-day" id="month-title">üìÖ Cumplea√±os del Mes</h2>
      <div id="month-view"></div>
    </section>

    <section class="section" id="year-section" style="display:none">
      <h2 class="title-day">üåé Cumplea√±os del A√±o</h2>
      <div id="year-view"></div>
    </section>
  </main>

  <footer>
    üèÉ‚Äç‚ôÄÔ∏è #Re-corre Toluca ¬∑ Cumplea√±os runners
    <div id="next-birthday"></div>
    <div id="countdown"></div>
  </footer>

  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* ====== CONFIG ====== */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTN-lWu2WBwCmFHqb8aI6ObDNvuGYjSoHdNE62eP4Gp7PXhgsOBRvN3h7uXRQWQNTcD7mttS5mjEouW/pub?output=csv";
    const TZ = 'America/Mexico_City';

    /* ====== UTILS DE FECHA ====== */
    const dayNames = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const at0 = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
    const fmtDM = d => d.toLocaleDateString('es-MX', { day:'2-digit', month:'short' }).replace('.', '');
    const fmtLongDM = d => d.toLocaleDateString('es-MX', { day:'2-digit', month:'long' });
    function mondayOfWeek(d){ const x = at0(d), w = x.getDay(); const diff=(w===0 ? -6 : 1-w); x.setDate(x.getDate()+diff); return x; }
    function sundayOfWeek(d){ const m=mondayOfWeek(d); const s=new Date(m); s.setDate(m.getDate()+6); return s; }

    function parseBirthdayToMD(value){
      if(value == null) return null;
      const s = String(value).trim();
      // YYYY-MM-DD / YYYY/MM/DD
      let m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if(m) return {m:parseInt(m[2],10), d:parseInt(m[3],10)};
      // DD/MM/YYYY o MM/DD/YYYY (desempate: si primer n¬∫ 10-12 => MM/DD; si no => DD/MM)
      if(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}$/.test(s)){
        const [a,b,yyyy] = s.replace(/-/g,'/').split('/').map(n=>parseInt(n,10));
        if(a>=10 && a<=12) return {m:a, d:b};
        if(b>=10 && b<=12) return {m:a, d:b}; // sigue siendo v√°lido
        return {m:b, d:a};
      }
      // MM/DD o DD/MM
      if(/^\d{1,2}[\/\-]\d{1,2}$/.test(s)){
        const [a,b] = s.replace(/-/g,'/').split('/').map(n=>parseInt(n,10));
        if(a>12 && b<=12) return {m:b, d:a}; // DD/MM
        if(a>=1 && a<=12 && b>=1 && b<=31) return {m:a, d:b}; // MM/DD
      }
      // Dots
      if(/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(s)){
        const [a,b,yyyy] = s.split('.').map(n=>parseInt(n,10));
        return (a>12) ? {m:b, d:a} : {m:a, d:b};
      }
      return null;
    }
    const toDateInYear = (mmdd, year) => { const [m,d] = mmdd.split('-').map(Number); return new Date(year, m-1, d); };

    /* ====== EFFECTS ====== */
    // Confeti
    function confettiBurst(n=160, dur=[1.8,3.0]){
      const colors=['#6faeff','#5977ff','#7a61ff','#00d1ff','#14e0a1','#ffe066','#ffffff'];
      for(let i=0;i<n;i++){
        const el=document.createElement('span'); el.className='confetti';
        el.style.left=(Math.random()*100)+'vw';
        el.style.background=colors[(Math.random()*colors.length)|0];
        el.style.animationDuration=(dur[0]+Math.random()*(dur[1]-dur[0]))+'s';
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 4000);
      }
    }

    // Estrellas
    (function stars(){
      const c=document.getElementById('stars'); const ctx=c.getContext('2d'); let W,H,stars=[];
      function resize(){W=c.width=innerWidth; H=c.height=innerHeight; spawn();}
      function spawn(){stars=new Array(100).fill(0).map(()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.8+0.6,a:Math.random()*0.5+0.4,speed:Math.random()*0.003+0.0015,phase:Math.random()*Math.PI*2}));}
      function tick(){ctx.clearRect(0,0,W,H); for(const s of stars){s.phase+=s.speed; const alpha=s.a*(0.5+0.5*Math.sin(s.phase)); const g=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*3); g.addColorStop(0,`rgba(255,255,255,${alpha})`); g.addColorStop(1,`rgba(255,255,255,0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();} requestAnimationFrame(tick);}
      addEventListener('resize',resize); resize(); tick();
    })();

    // Wallpapers carrusel
    const WALLPAPER_URLS=[
      "https://raw.githubusercontent.com/EdddGaar/recorre/9fb60180790371876c4d9b84db2b37396e653d83/cumple.jpg",
      "https://raw.githubusercontent.com/EdddGaar/recorre/9fb60180790371876c4d9b84db2b37396e653d83/wallpaper%20cumple%20morado.jpg",
      "https://raw.githubusercontent.com/EdddGaar/recorre/9fb60180790371876c4d9b84db2b37396e653d83/wallpaper%20de%20globos.jpg"
    ];
    function initWallpapers(){
      const wrap=document.querySelector('.wallpapers');
      WALLPAPER_URLS.forEach((src,i)=>{
        const img=document.createElement('img');
        img.src=src; img.alt="Wallpaper "+(i+1);
        if(i===0) img.classList.add('show');
        wrap.appendChild(img);
      });
      const imgs=[...wrap.querySelectorAll('img')];
      let idx=0;
      setInterval(()=>{
        imgs[idx].classList.remove('show');
        idx=(idx+1)%imgs.length;
        imgs[idx].classList.add('show');
      }, 5000);
    }

    /* ====== FRASES VAC√çO ====== */
    const frasesDivertidas=[
      "Esta semana nadie envejece‚Ä¶ qu√© aburridos",
      "Silencio en la pista‚Ä¶ ni un pastel que correr esta vez",
      "¬°Plot twist! Esta semana no hay pastel, solo kil√≥metros extra",
      "Nadie cumple, pero igual puedes festejar tus agujetas nuevas",
      "Semana libre de velitas‚Ä¶ aprovecha para bajar el tiempo en 10k",
      "Los cumplea√±eros hicieron trampa y se escondieron"
    ];
    function renderEmpty(container){
      container.innerHTML='';
      const empty=document.createElement('div'); empty.className='card empty-card';
      const p=document.createElement('p'); p.className='wish';
      p.textContent=frasesDivertidas[(Math.random()*frasesDivertidas.length)|0];
      empty.appendChild(p); container.appendChild(empty);
    }

    /* ====== CARGA CSV ====== */
    function stripAccentsLower(s){ return (s ?? '').toString().trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
    function findHeaderIndex(headers, candidates){
      const cleaned = headers.map(h=> stripAccentsLower(h));
      for(const cand of candidates){
        const c = stripAccentsLower(cand);
        for(let i=0;i<cleaned.length;i++){ if(cleaned[i].includes(c)) return i; }
      }
      return -1;
    }

    async function fetchBirthdaysFromCSV(){
      const res = await fetch(CSV_URL + "&_cb=" + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
      const csvText = await res.text();
      const parsed = Papa.parse(csvText, { header:false, skipEmptyLines:true });
      const rows = parsed.data || [];
      if(rows.length === 0) return [];

      const headers = rows[0].map(v => (v ?? '').toString().trim());
      const data = rows.slice(1);

      // Columnas
      const NAME_COL = findHeaderIndex(headers, ['nombre','‚úçÔ∏è nombre completo','name']);
      const PACE_COL = findHeaderIndex(headers, ['ritmo','pace']);
      let BIRTH_COL = findHeaderIndex(headers, ['edad','fecha de nacimiento','cumple','cumplea√±os']);
      if(BIRTH_COL === -1) BIRTH_COL = 3; // fallback a Col D si no encontr√≥

      if(NAME_COL === -1 || BIRTH_COL === -1) return [];

      const out=[];
      for(const row of data){
        const name = (row[NAME_COL] ?? '').toString().trim();
        const birthRaw = row[BIRTH_COL] != null ? String(row[BIRTH_COL]) : '';
        if(!name || !birthRaw) continue;

        const md = parseBirthdayToMD(birthRaw);
        if(!md || !(md.m>=1 && md.m<=12) || !(md.d>=1 && md.d<=31)) continue;

        const mm = String(md.m).padStart(2,'0');
        const dd = String(md.d).padStart(2,'0');
        const pace = (PACE_COL !== -1) ? (row[PACE_COL] ?? '').toString().trim() : '';

        out.push({ name, date:`${mm}-${dd}`, pace, wish:'' });
      }
      return out;
    }

    /* ====== AGRUPACIONES / RENDER ====== */
    function getWeekBlocks(list){
      const today = new Date(); const start = mondayOfWeek(today); const end = sundayOfWeek(today);
      const days=[]; for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); days.push(d); }

      const map = new Map(days.map(d=>[at0(d).getTime(), []]));
      for(const p of list){
        const candidates = [0,-1,1].map(off => toDateInYear(p.date, today.getFullYear()+off));
        const hit = candidates.find(dt => at0(dt) >= at0(start) && at0(dt) <= at0(end));
        if(hit){ map.get(at0(hit).getTime()).push(p); }
      }

      const out=[]; const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
      for(const d of days){
        const label = at0(d).getTime()===at0(today).getTime() ? 'HOY'
                    : at0(d).getTime()===at0(tomorrow).getTime() ? 'Ma√±ana'
                    : dayNames[d.getDay()];
        out.push({label, date:d, items:map.get(at0(d).getTime())||[]});
      }
      out.sort((a,b)=>{ const rank=v=>v.label==='HOY'?0:v.label==='Ma√±ana'?1:2; return rank(a)-rank(b)||a.date-b.date });
      return out;
    }

    function renderWeek(list){
      const wrap = document.getElementById('week-view');
      wrap.innerHTML = '';
      const blocks = getWeekBlocks(list);
      let hadToday=false;

      blocks.forEach(g=>{
        const section=document.createElement('section'); section.className='section';
        const h=document.createElement('h2'); h.className='title-day'+(g.label==='HOY'?'':' small'); h.textContent=g.label; section.appendChild(h);

        const cards=document.createElement('div'); cards.className='cards';
        if(!g.items.length){ renderEmpty(cards); }
        else{
          g.items.sort((a,b)=> a.name.localeCompare(b.name)).forEach(p=>{
            const c=document.createElement('div'); c.className='card';
            c.innerHTML = `
              <p class="name">${p.name}</p>
              <p class="meta">${fmtDM(toDateInYear(p.date, new Date().getFullYear()))} ¬∑ ${p.pace||'Runner'}</p>
              <p class="wish">¬°Muchas felicidades!</p>`;
            cards.appendChild(c);
          });
        }
        section.appendChild(cards); wrap.appendChild(section);
        if(g.label==='HOY' && g.items.length) hadToday=true;
      });

      confettiBurst(hadToday ? 160 : 60, hadToday ? [1.6,2.6] : [1.2,1.8]);
    }

    function renderMonth(list){
      const now=new Date(); const curM = now.getMonth()+1;
      const thisMonth = list.filter(p => parseInt(p.date.split('-')[0],10) === curM)
                            .sort((a,b)=> a.date.localeCompare(b.date) || a.name.localeCompare(b.name));
      const wrap = document.getElementById('month-view');
      const title = document.getElementById('month-title');
      title.textContent = `üìÖ Cumplea√±os de ${monthNames[now.getMonth()]}`;
      wrap.innerHTML='';

      if(!thisMonth.length){ renderEmpty(wrap); return; }

      const cards=document.createElement('div'); cards.className='cards';
      thisMonth.forEach(p=>{
        const [m,d]=p.date.split('-').map(Number);
        const dt = new Date(now.getFullYear(), m-1, d);
        const c=document.createElement('div'); c.className='card';
        c.id = `day-${String(d).padStart(2,'0')}`;
        c.innerHTML = `
          <p class="name">${p.name}</p>
          <p class="meta">${fmtLongDM(dt)} ¬∑ ${p.pace||'Runner'}</p>
          <p class="wish">üéÇ ¬°Muchas felicidades!</p>`;
        cards.appendChild(c);
      });
      wrap.appendChild(cards);
    }

    function renderYear(list){
      const wrap = document.getElementById('year-view');
      wrap.innerHTML='';
      const groups = Array.from({length:12},()=>[]);
      list.forEach(p=>{
        const m = parseInt(p.date.split('-')[0],10);
        groups[m-1].push(p);
      });

      let hasAny=false;
      groups.forEach((arr, i)=>{
        if(!arr.length) return;
        hasAny=true;
        const section=document.createElement('section'); section.className='section';
        const h=document.createElement('h2'); h.className='title-day'; h.textContent=monthNames[i]; section.appendChild(h);

        const cards=document.createElement('div'); cards.className='cards';
        arr.sort((a,b)=> a.date.localeCompare(b.date) || a.name.localeCompare(b.name)).forEach(p=>{
          const [m,d]=p.date.split('-').map(Number);
          const dt = new Date(new Date().getFullYear(), m-1, d);
          const c=document.createElement('div'); c.className='card';
          c.innerHTML = `
            <p class="name">${p.name}</p>
            <p class="meta">${fmtLongDM(dt)} ¬∑ ${p.pace||'Runner'}</p>
            <p class="wish">üéâ ¬°Muchas felicidades!</p>`;
          cards.appendChild(c);
        });
        section.appendChild(cards); wrap.appendChild(section);
      });

      if(!hasAny) renderEmpty(wrap);
    }

    /* ====== COUNTDOWN AL PR√ìXIMO ====== */
    function getNextBirthday(birthdays){
      const today=at0(new Date());
      const upcoming=birthdays.map(p=>{
        const [m,d]=p.date.split('-').map(Number);
        let next=new Date(today.getFullYear(),m-1,d,0,0,0);
        if(next<today) next.setFullYear(next.getFullYear()+1);
        const diffDays=Math.ceil((next-today)/(1000*60*60*24));
        return {...p,next,diffDays};
      }).sort((a,b)=>a.diffDays-b.diffDays);
      return upcoming.length?upcoming[0]:null;
    }
    function startCountdown(date){
      const el=document.getElementById('countdown');
      function tick(){
        const now=new Date();
        const diff=date-now;
        if(diff<=0){ el.textContent="üéâ ¬°Es hoy!"; return; }
        const d=Math.floor(diff/(1000*60*60*24));
        const h=Math.floor((diff%(1000*60*60*24))/(1000*60*60));
        const m=Math.floor((diff%(1000*60*60))/(1000*60));
        const s=Math.floor((diff%(1000*60))/1000);
        el.textContent=`‚è≥ ${d}d ${h}h ${m}m ${s}s`;
        requestAnimationFrame(tick);
      }
      tick();
    }
    function renderCountdown(){
      const next=getNextBirthday(window.BIRTHDAYS||[]);
      const el=document.getElementById('next-birthday');
      if(next){
        if(next.diffDays===0){
          el.innerHTML=`üéâ Hoy cumple <strong>${next.name}</strong>!`;
          document.getElementById('countdown').textContent="üéÇ ¬°Festejando!";
        } else {
          const [m,d]=next.date.split('-').map(Number);
          const dt=new Date(new Date().getFullYear(), m-1, d);
          el.innerHTML=`üéÇ El pr√≥ximo cumple es de <strong>${next.name}</strong> (${fmtLongDM(dt)})`;
          startCountdown(next.next);
        }
      } else {
        el.textContent='Sin cumplea√±eros pr√≥ximos üí§';
        document.getElementById('countdown').textContent='';
      }
    }

    /* ====== BOOT / VISTAS ====== */
    let CURRENT_VIEW='week';

    function setActive(btnId){
      document.querySelectorAll('.toolbar .btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(btnId).classList.add('active');
    }
    function showView(view){
      CURRENT_VIEW=view;
      document.getElementById('week-section').style.display = (view==='week')?'':'none';
      document.getElementById('month-section').style.display = (view==='month')?'':'none';
      document.getElementById('year-section').style.display = (view==='year')?'':'none';
      setActive(view==='week'?'btn-week':view==='month'?'btn-month':'btn-year');
      if(view==='week'){
        // Scroll a HOY si existe
        const hoy=[...document.querySelectorAll('#week-section .title-day')].find(n=> n.textContent.trim()==='HOY');
        if(hoy) hoy.scrollIntoView({behavior:'smooth',block:'start'});
      } else if(view==='month'){
        // Scroll al d√≠a de hoy si existe
        const dd = String(new Date().getDate()).padStart(2,'0');
        const anchor = document.getElementById('day-'+dd);
        if(anchor) anchor.scrollIntoView({behavior:'smooth',block:'center'});
      } else if(view==='year'){
        // Scroll al mes actual
        const cur = monthNames[new Date().getMonth()];
        const h2 = [...document.querySelectorAll('#year-section h2')].find(h=>h.textContent===cur);
        if(h2) h2.scrollIntoView({behavior:'smooth',block:'start'});
      }
    }

    async function boot(force=false){
      const status = document.getElementById('status');
      try{
        status.textContent = force ? 'Actualizando‚Ä¶' : 'Cargando cumplea√±er@s‚Ä¶';
        const list = await fetchBirthdaysFromCSV();
        window.BIRTHDAYS = list;
        // Render inicial de las 3 vistas (para poder alternar sin volver a cargar)
        renderWeek(list);
        renderMonth(list);
        renderYear(list);
        renderCountdown();

        status.textContent = list.length ? 'üéâ Lista cargada' : 'No se encontraron cumplea√±er@s';
        // Mantener la vista actual al recargar
        showView(CURRENT_VIEW);
      }catch(err){
        console.error(err);
        window.BIRTHDAYS = [];
        document.getElementById('week-view').innerHTML='';
        document.getElementById('month-view').innerHTML='';
        document.getElementById('year-view').innerHTML='';
        renderEmpty(document.getElementById('week-view'));
        status.textContent = 'No se pudo cargar la lista de cumplea√±os.';
      }
    }

    function scheduleMidnightReload(){
      const now=new Date(); const midnight=new Date(now); midnight.setHours(24,0,0,0);
      setTimeout(()=>{ boot(true); scheduleMidnightReload(); }, midnight-now);
    }

    /* ====== EVENTOS UI ====== */
    document.getElementById('btn-celebrar').addEventListener('click',()=>confettiBurst());
    document.getElementById('btn-hoy').addEventListener('click',()=>{
      if(CURRENT_VIEW==='week'){
        const hoy=[...document.querySelectorAll('#week-section .title-day')].find(n=> n.textContent.trim()==='HOY');
        if(hoy) hoy.scrollIntoView({behavior:'smooth',block:'start'});
      } else if(CURRENT_VIEW==='month'){
        const dd = String(new Date().getDate()).padStart(2,'0');
        const anchor = document.getElementById('day-'+dd);
        if(anchor) anchor.scrollIntoView({behavior:'smooth',block:'center'});
      } else {
        const cur = monthNames[new Date().getMonth()];
        const h2 = [...document.querySelectorAll('#year-section h2')].find(h=>h.textContent===cur);
        if(h2) h2.scrollIntoView({behavior:'smooth',block:'start'});
      }
    });
    document.getElementById('btn-week').addEventListener('click',()=>showView('week'));
    document.getElementById('btn-month').addEventListener('click',()=>showView('month'));
    document.getElementById('btn-year').addEventListener('click',()=>showView('year'));
    document.getElementById('btn-reload').addEventListener('click',()=>boot(true));

    document.addEventListener('DOMContentLoaded', ()=>{
      initWallpapers();
      boot();
      scheduleMidnightReload();
    });
  </script>
</body>
</html>
